# Task 3 — Анализ текущей архитектуры и рисков масштабирования

Обзор проблем и рисков, выявленных в текущей архитектуре InsureTech и по результатам инцидентов.  
**Функциональная декомпозиция сервисов не изменяется** — фокус на интеграциях, надежности и эксплуатационных аспектах перед ростом нагрузки.

---

## 1. Производительность и поведение под нагрузкой
- **Долгая загрузка страниц при пиках**: при ~50 RPS поиска и ~10 RPS оформления наблюдаются задержки и таймауты — признак блокирующих внешних вызовов и перегрузки монолита `core-app`.  
- **Синхронная агрегация в `ins-product-aggregator`**: fan-out вызовы к 5 (вскоре 10) страховым → каскадные задержки, рост P95/P99 латентности.  
- **Регулярный REST-поллинг** каталога (`core-app` — каждые 15 минут, `ins-comp-settlement` — раз в сутки) создаёт окна несвежих данных и нагрузочные пики на агрегатор.  
- **Нет механизмов backpressure** — всплески входящего трафика мгновенно передаются всем зависимым сервисам.

---

## 2. SLA и изоляция трафика партнёров
- **Проблема “noisy neighbor”**: отдельные партнёры превышают лимиты (до 250 RPS при договорных 20 RPS) → отсутствие централизованного контроля RPS, квот и burst-лимитов.  
- Партнёрские API доступны напрямую через Load Balancer → нет **API Gateway** с политиками безопасности, лимитирования, WAF и fallback-механизмами (моки/трешбины при авариях).

---

## 3. Доступность и отказоустойчивость
- **Single-AZ-развёртывание** приложений и БД → риск полной недоступности при сбое зоны.  
- **PostgreSQL в одиночном экземпляре (master-only)** → точка отказа, отсутствие failover и read-реплик.  
- **Синхронные цепочки** (`core → aggregator → страховые`) без fallback-кэша → при сбое внешних интеграций деградирует UX фронта.

---

## 4. Надёжность интеграций и консистентность данных
- Ошибки и таймауты при REST-вызовах к страховым, нет изоляции по источникам (отсутствуют per-insurer rate limit, circuit breaker, retries с jitter).  
- Ночной REST-запрос `ins-comp-settlement` к `core-app` → риск пропусков и расхождений, сложные ретраи.  
- Нет формализованных **событийных контрактов**, Schema Registry, DLQ и механизма реплея сообщений.

---

## 5. Наблюдаемость и эксплуатация
- Недостаточная проактивная **мониторинг/алертинг** по SLO (RPS, ошибки, латентность, saturation).  
- Нет **сквозной трассировки** вызовов (correlation ID), затруднена диагностика узких мест.  
- HPA и автоскейлинг не привязаны к реальным бизнес-метрикам и нагрузке очередей.

---

# Риски при росте нагрузки
- Увеличение числа страховых (5 → 10) усилит латентность и частоту отказов при синхронной агрегации.  
- Всплески поискового трафика (рекламные кампании) вызовут массовые fan-out-запросы и лавинообразные таймауты (thundering herd).  
- Без лимитов партнёры смогут снова перегружать сервис, вызывая SLA-инциденты.  
- **Single-AZ и single-instance БД** → потенциальные простои (≈ 500 тыс. ₽/час).  
- **Polling и ночные батчи** → нестабильная консистентность, ручное восстановление данных.

---

# Предлагаемые меры (без изменения функциональной декомпозиции)
1. **Event Streaming вместо REST-polling и синхронных цепочек**  
   - Топик `products.offers.v2`: публикация `ins-product-aggregator` обновлений тарифов; локальные проекции в `core-app` и `ins-comp-settlement`.  
   - Топик `policies.issued.v1`: публикация `core-app` фактов оформления; `ins-comp-settlement` формирует реестры near real-time.  

2. **Transactional Outbox** в `core-app` и `ins-product-aggregator` для гарантированной публикации событий при коммите транзакции.  

3. **API Gateway** на входе B2B API:  
   аутентификация по ключам, **rate limit/quotas (20 RPS на партнёра)**, burst-буферы, circuit breakers, WAF.  

4. **Кэши и проекции для чтения** (CQRS):  
   фронт обслуживается из локального кэша/БД, а не через внешние интеграции.  

5. **Повышение надёжности и доступности**:  
   - PostgreSQL → репликация, авто-failover, разделение чтений, бэкапы и PITR.  
   - Кластер и БД развёрнуты в 2–3 AZ; readiness/liveness пробы; pod disruption budgets.  

6. **Наблюдаемость и операции**:  
   дашборды по SLO, P95/P99, ошибкам, consumer lag; трассировка; DLQ; процедуры реплея.  

7. **Изоляция интеграций**:  
   per-insurer rate limit, таймауты и retries с backoff, circuit breakers, scheduler с ограничением конкуррентности на источник.  
